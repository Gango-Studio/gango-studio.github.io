<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>终极节拍器</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f8f9fa;
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            min-height: 100vh;
            touch-action: manipulation;
        }

        .wheel-container {
            position: relative;
            width: min(80vw, 300px);
            height: min(80vw, 300px);
            margin: 2rem;
        }

        .control-wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            box-shadow: 8px 8px 16px #d9d9d9,
                      -8px -8px 16px #ffffff;
            cursor: grab;
            touch-action: none;
            transition: transform 0.1s ease-out;
        }

        .control-wheel:active {
            cursor: grabbing;
        }

        .center-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 35%;
            height: 35%;
            background: #f8f8f8;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: inset 3px 3px 6px #d9d9d9,
                      inset -3px -3px 6px #ffffff;
        }

        #bpm {
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: 600;
            color: #2d3436;
        }

        button {
            margin: 1rem;
            padding: 0.8rem 2rem;
            font-size: 1.1rem;
            background: #f8f9fa;
            border: none;
            border-radius: 2rem;
            box-shadow: 4px 4px 8px #d9d9d9,
                      -4px -4px 8px #ffffff;
            color: #2d3436;
            transition: all 0.2s ease;
        }

        button:active {
            box-shadow: inset 2px 2px 4px #d9d9d9,
                      inset -2px -2px 4px #ffffff;
        }
    </style>
</head>
<body>
    <div class="wheel-container">
        <div class="control-wheel"></div>
        <div class="center-display">
            <span id="bpm">120</span>
            <span>BPM</span>
        </div>
    </div>
    <button id="toggle">Start</button>

    <script>
        (() => {
            // 配置常量
            const CONFIG = {
                MIN_BPM: 30,
                MAX_BPM: 240,
                BASE_BPM: 120,
                SENSITIVITY: 0.7,
                DRIFT_CORRECTION: 0.2
            };

            // 状态管理
            let state = {
                isPlaying: false,
                rotation: 0,
                bpm: CONFIG.BASE_BPM,
                nextTickTime: 0,
                audioContext: null,
                audioBuffer: null,
                schedulerId: 0,
                lastTickTime: 0
            };

            // 初始化音频系统
            async function initAudioSystem() {
                try {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const response = await fetch('metronome.wav');
                    const arrayBuffer = await response.arrayBuffer();
                    state.audioBuffer = await state.audioContext.decodeAudioData(arrayBuffer);
                } catch (error) {
                    console.error('音频初始化失败:', error);
                }
            }

            // 播放节拍音效（修复核心问题）
            function playTick(scheduledTime) {
                if (!state.audioBuffer) return;

                // 每次创建新的音频节点
                const source = state.audioContext.createBufferSource();
                source.buffer = state.audioBuffer;
                source.connect(state.audioContext.destination);
                
                // 使用精确的音频API时间调度
                const currentTime = state.audioContext.currentTime;
                const playTime = scheduledTime || currentTime;
                
                source.start(playTime);
                
                // 防止内存泄漏
                source.onended = () => source.disconnect();
            }

            // 改进的调度器
            function schedule() {
                if (!state.isPlaying) return;

                const now = performance.now();
                const interval = 60000 / state.bpm;
                
                // 动态误差补偿
                let drift = now - state.nextTickTime;
                state.nextTickTime += interval - Math.min(drift, interval * 0.5);

                // 调度下一次执行
                const timeUntilNext = state.nextTickTime - now;
                const scheduleDelay = Math.max(0, timeUntilNext - 5); // 提前5ms调度

                // 使用Web Audio API的精确时间
                if (state.audioContext) {
                    const audioTime = state.audioContext.currentTime + (scheduleDelay / 1000);
                    playTick(audioTime);
                } else {
                    setTimeout(() => playTick(), scheduleDelay);
                }

                // 更新调度
                state.schedulerId = setTimeout(schedule, Math.max(0, timeUntilNext - 10));
            }

            // BPM控制
            function updateBpm(newBpm) {
                state.bpm = Math.max(CONFIG.MIN_BPM, 
                                    Math.min(CONFIG.MAX_BPM, Math.round(newBpm)));
                document.getElementById('bpm').textContent = state.bpm;
            }

            // 控制切换
            function toggleMetronome() {
                state.isPlaying = !state.isPlaying;
                document.getElementById('toggle').textContent = state.isPlaying ? 'Stop' : 'Start';
                
                if (state.isPlaying) {
                    state.nextTickTime = performance.now();
                    schedule();
                } else {
                    clearTimeout(state.schedulerId);
                }
            }

            // 旋转控制逻辑（保持原有实现）
            function setupWheelControl() {
                // 原有旋转控制代码
            }

            // 初始化
            async function init() {
                await initAudioSystem();
                setupWheelControl();
                document.getElementById('toggle').addEventListener('click', toggleMetronome);
            }

            init();
        })();
    </script>
</body>
</html>
