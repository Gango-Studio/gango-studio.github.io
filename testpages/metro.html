<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电车GO 山手線スタイル</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
        }
        body {
            background-color: #006847;
            color: white;
            font-family: 'MS Gothic', 'Osaka', 'Meiryo', sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        #display {
            flex: 1;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow: auto;
        }
        .display-panel {
            width: 100%;
            max-width: 500px;
            background-color: #111;
            border: 3px solid #fff;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .station-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .station-label {
            font-size: 22px;
            color: #ccc;
        }
        .station-name {
            font-size: 28px;
            font-weight: bold;
        }
        .current-station {
            color: #fff;
        }
        .next-station {
            color: #8cff00;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .info-box {
            flex: 1;
            margin: 0 5px;
        }
        .info-label {
            font-size: 18px;
            color: #ccc;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 32px;
            font-weight: bold;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #222;
            border-radius: 5px;
            padding: 5px;
        }
        .speed-value {
            color: #0f0;
        }
        .distance-value {
            color: #8cff00;
        }
        #controls {
            height: 150px;
            background-color: #111;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            border-top: 3px solid #fff;
        }
        .control-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 10px;
        }
        .control-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #333;
            color: white;
            border: 3px solid #666;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .control-btn:active {
            background-color: #555;
        }
        #accelerate {
            background-color: #d22;
        }
        #brake {
            background-color: #006847;
        }
        #stop {
            background-color: #ff0;
            color: #000;
        }
        #speedNotches {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-bottom: 10px;
        }
        .speed-notch {
            width: 40px;
            height: 20px;
            background-color: #333;
            border: 1px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .speed-notch.active {
            background-color: #8cff00;
        }
        #message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 15px 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
            border: 2px solid #8cff00;
            z-index: 100;
        }
        #scoreDisplay {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #8cff00;
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="display">
        <div class="display-panel">
            <div class="station-row">
                <span class="station-label">現在:</span>
                <span class="station-name current-station">Pigsty</span>
            </div>
            <div class="station-row">
                <span class="station-label">次:</span>
                <span class="station-name next-station">新橋</span>
            </div>
            
            <div class="info-row">
                <div class="info-box">
                    <div class="info-label">速度</div>
                    <div class="info-value speed-value">0 km/h</div>
                </div>
                <div class="info-box">
                    <div class="info-label">距離</div>
                    <div class="info-value distance-value">1900 m</div>
                </div>
            </div>
        </div>
        
        <div id="scoreDisplay">
            <div>スコア: <span id="scoreValue">0</span></div>
            <div>停車精度: <span id="accuracyValue">0</span>%</div>
            <div>完走回数: <span id="lapsValue">0</span></div>
        </div>
        
        <div id="message"></div>
    </div>
    
    <div id="controls">
        <div id="speedNotches">
            <div class="speed-notch" data-level="1">1</div>
            <div class="speed-notch" data-level="2">2</div>
            <div class="speed-notch" data-level="3">3</div>
            <div class="speed-notch" data-level="4">4</div>
            <div class="speed-notch" data-level="5">5</div>
        </div>
        <div class="control-row">
            <div id="brake" class="control-btn">減速</div>
            <div id="stop" class="control-btn">停車</div>
            <div id="accelerate" class="control-btn">加速</div>
        </div>
    </div>
    
    <script>
        // 游戏主对象
        const game = {
            trainAngle: 0,
            speed: 0,
            maxSpeed: 0.02,
            speedLevel: 0,
            speedLevels: [0, 0.004, 0.008, 0.012, 0.016, 0.02],
            acceleration: 0.0005,
            deceleration: 0.0008,
            brakingDeceleration: 0.0015,
            currentStationIndex: 0,
            approachingStation: null,
            isInStation: false,
            laps: 0,
            score: 0,
            totalStops: 0,
            successfulStops: 0,
            stations: [
                { name: "Pigsty", angle: 0 },
                { name: "新橋", angle: Math.PI * (1900 / 3000) } // 修改为1900米间距
            ],
            gameLoopId: null,
            kmhConversionFactor: 1800,
            meterConversionFactor: 1, // 直接使用米作为单位
            trackLength: 3000, // 虚拟轨道长度(米) - 用于计算角度
            accelerating: false,
            braking: false,
            accelerationInterval: null,
            brakeInterval: null,
            
            init() {
                const accelerateBtn = document.getElementById('accelerate');
                const brakeBtn = document.getElementById('brake');
                const stopBtn = document.getElementById('stop');
                
                // 触摸事件
                accelerateBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startAccelerate();
                }, { passive: false });
                
                accelerateBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.stopAccelerate();
                }, { passive: false });
                
                brakeBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startBrake();
                }, { passive: false });
                
                brakeBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    this.stopBrake();
                }, { passive: false });
                
                stopBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.stopTrain();
                }, { passive: false });
                
                // 鼠标事件
                accelerateBtn.addEventListener('mousedown', this.startAccelerate.bind(this));
                accelerateBtn.addEventListener('mouseup', this.stopAccelerate.bind(this));
                accelerateBtn.addEventListener('mouseleave', this.stopAccelerate.bind(this));
                
                brakeBtn.addEventListener('mousedown', this.startBrake.bind(this));
                brakeBtn.addEventListener('mouseup', this.stopBrake.bind(this));
                brakeBtn.addEventListener('mouseleave', this.stopBrake.bind(this));
                
                stopBtn.addEventListener('click', this.stopTrain.bind(this));
                
                // 键盘控制
                window.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowUp') this.startAccelerate();
                    if (e.key === 'ArrowDown') this.startBrake();
                    if (e.key === ' ') this.stopTrain();
                });
                
                window.addEventListener('keyup', (e) => {
                    if (e.key === 'ArrowUp') this.stopAccelerate();
                    if (e.key === 'ArrowDown') this.stopBrake();
                });
                
                this.gameLoop();
            },
            
            gameLoop() {
                this.update();
                this.gameLoopId = requestAnimationFrame(this.gameLoop.bind(this));
            },
            
            stopGameLoop() {
                if (this.gameLoopId) {
                    cancelAnimationFrame(this.gameLoopId);
                    this.gameLoopId = null;
                }
            },
            
            update() {
                // 更新电车位置 (基于实际距离计算)
                const distancePerFrame = this.speed * this.trackLength / (2 * Math.PI);
                this.trainAngle += (distancePerFrame / this.trackLength) * 2 * Math.PI;
                
                if (this.trainAngle >= Math.PI * 2) {
                    this.trainAngle -= Math.PI * 2;
                    this.laps++;
                    document.getElementById('lapsValue').textContent = this.laps;
                }
                
                this.updateSpeedLevel();
                this.checkStations();
                this.updateUI();
            },
            
            updateUI() {
                const speedKmh = Math.floor(this.speed * this.kmhConversionFactor);
                document.querySelector('.speed-value').textContent = `${speedKmh} km/h`;
                
                if (this.approachingStation !== null) {
                    const nextStation = this.stations[this.approachingStation];
                    let angleDiff = nextStation.angle - this.trainAngle;
                    if (angleDiff < 0) angleDiff += Math.PI * 2;
                    
                    // 计算实际距离（米）
                    const distance = Math.floor(angleDiff * this.trackLength / (2 * Math.PI));
                    document.querySelector('.distance-value').textContent = `${distance} m`;
                } else {
                    // 计算到下一站的初始距离
                    const nextStationIndex = (this.currentStationIndex + 1) % this.stations.length;
                    const nextStation = this.stations[nextStationIndex];
                    let angleDiff = nextStation.angle - this.trainAngle;
                    if (angleDiff < 0) angleDiff += Math.PI * 2;
                    const distance = Math.floor(angleDiff * this.trackLength / (2 * Math.PI));
                    document.querySelector('.distance-value').textContent = `${distance} m`;
                }
            },
            
            updateSpeedLevel() {
                const notches = document.querySelectorAll('.speed-notch');
                notches.forEach((notch, index) => {
                    notch.classList.toggle('active', index <= this.speedLevel);
                });
            },
            
            checkStations() {
                const nextStationIndex = (this.currentStationIndex + 1) % this.stations.length;
                const nextStation = this.stations[nextStationIndex];
                
                let angleDiff = nextStation.angle - this.trainAngle;
                if (angleDiff < 0) angleDiff += Math.PI * 2;
                
                // 转换为实际距离（米）
                const distance = angleDiff * this.trackLength / (2 * Math.PI);
                
                // 如果接近车站（距离小于150米）
                if (distance < 150 && !this.isInStation) {
                    this.approachingStation = nextStationIndex;
                    document.querySelector('.next-station').textContent = nextStation.name;
                    
                    // 计算需要的减速度
                    const requiredDeceleration = (this.speed * this.speed * this.trackLength * this.trackLength) / (2 * angleDiff * (2 * Math.PI) * (2 * Math.PI));
                    
                    if (requiredDeceleration > this.brakingDeceleration * 1.5) {
                        this.showMessage("減速不足! 速度を落としてください!");
                    }
                }
                
                // 如果进入车站区域（距离小于20米）
                if (distance < 20) {
                    this.isInStation = true;
                    this.totalStops++;
                    
                    // 如果速度足够低（小于3.6km/h），可以停车
                    if (this.speed * this.kmhConversionFactor < 3.6) {
                        // 计算停靠精度 (0-100%)
                        const stopAccuracy = Math.max(0, 100 - Math.floor(Math.abs(distance - 10)));
                        this.successfulStops++;
                        this.score += 100 + stopAccuracy;
                        
                        this.showMessage(`${nextStation.name} 停車成功! 精度: ${stopAccuracy}%`);
                        this.updateScore();
                        
                        this.currentStationIndex = nextStationIndex;
                        document.querySelector('.current-station').textContent = nextStation.name;
                        
                        const newNextIndex = (this.currentStationIndex + 1) % this.stations.length;
                        document.querySelector('.next-station').textContent = this.stations[newNextIndex].name;
                        
                        setTimeout(() => {
                            this.isInStation = false;
                        }, 3000);
                    } else {
                        this.showMessage(`通過: ${nextStation.name}`);
                        this.updateScore();
                        
                        setTimeout(() => {
                            this.isInStation = false;
                            this.currentStationIndex = nextStationIndex;
                            document.querySelector('.current-station').textContent = nextStation.name;
                            
                            const newNextIndex = (this.currentStationIndex + 1) % this.stations.length;
                            document.querySelector('.next-station').textContent = this.stations[newNextIndex].name;
                        }, 1000);
                    }
                    
                    this.approachingStation = null;
                }
            },
            
            updateScore() {
                document.getElementById('scoreValue').textContent = this.score;
                const accuracy = this.totalStops > 0 ? Math.floor((this.successfulStops / this.totalStops) * 100) : 0;
                document.getElementById('accuracyValue').textContent = accuracy;
            },
            
            showMessage(msg) {
                const messageElement = document.getElementById('message');
                messageElement.textContent = msg;
                messageElement.style.display = 'block';
                
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 2000);
            },
            
            startAccelerate() {
                if (this.speedLevel < 5 && !this.isInStation && !this.accelerating) {
                    this.accelerating = true;
                    this.accelerationInterval = setInterval(() => {
                        this.speed = Math.min(this.speed + this.acceleration, this.speedLevels[this.speedLevel + 1]);
                        if (this.speed >= this.speedLevels[this.speedLevel + 1] * 0.95) {
                            this.speedLevel = Math.min(this.speedLevel + 1, 5);
                            this.stopAccelerate();
                        }
                    }, 16);
                }
            },
            
            stopAccelerate() {
                if (this.accelerating) {
                    clearInterval(this.accelerationInterval);
                    this.accelerating = false;
                }
            },
            
            startBrake() {
                if (this.speedLevel > 0 && !this.braking) {
                    this.braking = true;
                    this.brakeInterval = setInterval(() => {
                        this.speed = Math.max(this.speed - this.deceleration, this.speedLevels[this.speedLevel - 1]);
                        if (this.speed <= this.speedLevels[this.speedLevel - 1] * 1.05) {
                            this.speedLevel = Math.max(this.speedLevel - 1, 0);
                            this.stopBrake();
                        }
                    }, 16);
                }
            },
            
            stopBrake() {
                if (this.braking) {
                    clearInterval(this.brakeInterval);
                    this.braking = false;
                }
            },
            
            stopTrain() {
                if (this.approachingStation !== null && !this.isInStation) {
                    this.braking = true;
                    clearInterval(this.brakeInterval);
                    this.brakeInterval = setInterval(() => {
                        this.speed = Math.max(this.speed - this.brakingDeceleration, 0);
                        if (this.speed === 0) {
                            this.speedLevel = 0;
                            this.stopBrake();
                        }
                    }, 16);
                }
            }
        };

        // 启动游戏
        window.onload = () => game.init();

        // 确保游戏循环在页面卸载时停止
        window.addEventListener('beforeunload', () => {
            game.stopGameLoop();
        });
    </script>
</body>
</html>
